name: Deploy to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        # Test that the app can be imported
        cd backend
        python -c "from main import app; print('App loaded successfully')"
    
    - name: Verify health endpoint
      run: |
        cd backend
        pip install requests
        python -c "
import requests
from main import app
import threading

# Start the app in a thread
def run_app():
    app.run(host='127.0.0.1', port=5555, debug=False, use_reloader=False)

thread = threading.Thread(target=run_app)
thread.daemon = True
thread.start()

# Wait for the server to start
import time
time.sleep(3)

# Test the health endpoint
try:
    response = requests.get('http://127.0.0.1:5555/api/health')
    print(f'Status: {response.status_code}')
    print(f'Response: {response.json()}')
except Exception as e:
    print(f'Error: {e}')
"
